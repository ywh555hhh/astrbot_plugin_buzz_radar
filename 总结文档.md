# BuzzRadar v3.2 技术总结与演进文档

## 1. 核心触发机制详解 (The Core Mechanic)

当前版本 (v3.2) 摒弃了早期单纯依赖“消息数量”的线性逻辑，转而采用 **"时空窗口 + 人群乘区"** 的复合算法，旨在模仿人类对“热闹”的感知。

### A. 时间窗口 (Time Window)
不再傻瓜式地统计“最后20条消息”，而是维护一个 **10分钟滑动时间窗**。
- **机制**：每一条新消息进来，系统会自动清理掉 `Now - 10min` 之前的旧数据（包括活跃用户标记和消息缓存）。
- **目的**：确保雷达只通过“当下的热度”触发，避免“早上聊得火热，下午突然触发总结”的延迟尴尬。

### B. 人群乘区 (Crowd Multiplier)
这是 v3.0 的核心质变。我们引入了“人群系数”来放大热度。
$$
\text{FinalScore} = \text{BaseScore} + (\text{ActiveUserCount} \times \text{CrowdWeight}) + \text{NewFaceBonus}
$$
- **活跃用户 (ActiveUserCount)**：过去 10 分钟内发言过的人数。
- **人群权重 (CrowdWeight)**：目前设为 2.0。这意味着每多一个活人进场，热度增长速度就翻倍。
- **生面孔奖励 (NewFaceBonus)**：如果一个沉寂已久的用户突然说话，直接奖励 20 分。这极大地增加了“炸鱼”效果——潜水员被炸出来时，热度瞬间飙升。

### C. 速度阈值 (Velocity Threshold)
除了绝对分数（如 80分）触发外，我们还监控 **热度加速度**。
- 如果 `当前热度 / 上一周期热度 > 2.0`（瞬间翻倍），即使总分未到，也会强制触发（前提是过了冷却期）。
- 这模拟了“突发新闻”的传播模式。

---

## 2. 开发踩坑与经验总结 (Pitfalls & Lessons)

在 v3.x 的迭代过程中，我们踩了几个典型的坑，这些经验非常宝贵：

### 🛑 坑1：配置的“幽灵默认值”
- **现象**：在 `Schema` 里写了默认 Prompt，但用户配置界面却是空白的。
- **原因**：用户的旧配置文件里已经有了 `custom_prompt: ""`（空字符串）。AstrBot 读取配置时，优先读取了用户的空值，而不是 Schema 的默认值。
- **解决**：**Key Migration (键名迁移)**。将 `custom_prompt` 重命名为 `summary_prompt`。系统识别为新键，强制应用了新的默认值。
- **教训**：想强制刷新用户的配置，改 Key 是最快的方法。

### 🛑 坑2：Prompt 的“分类陷阱”
- **现象**：AI 总是输出 “动漫角色讨论”、“游戏讨论” 这种正确的废话。
- **原因**：Few-Shot 示例给得太笼统（如 `Keyword: 吃饭`）。LLM 学会了“归纳法”。
- **解决**：**具体化示例**。将示例改为 `Keyword: 正在讨论今晚去吃海底捞`。同时加入负面约束 `❌ 严禁包含“讨论”、“关于”`。
- **教训**：LLM 是模仿大师。你想让它写“震惊体”，你的 Example 就必须足够“震惊”。

### 🛑 坑3：代码层面的盲目自信 (`AttributeError`, `NameError`)
- **现象**：直接使用 `self.metadata.name` 导致崩溃；在无 `event` 上下文中调用 `event.plain_result`。
- **解决**：回归框架标准。使用 `self.config` 和 `self.namespace`；遵循底层 API (`MessageEventResult`)。
- **教训**：不要凭印象写标准库调用，尤其是 `event` 对象这种上下文敏感的东西。

---

## 3. 他山之石 (Learnings from Others)

### 📚 From `astrbot_qq_group_daily_analysis` (QQ Daily)
1.  **UI 交互体验**：Prompt 编辑应当使用 `type: "text"` (Text Area) 而非 `string`。Prompt 通常很长，单行输入框是反人类的。v3.2 已跟进此项改进。
2.  **配置命名规范**：`summary_prompt` 比 `custom_prompt` 更具语义性。
3.  **文档驱动开发**：他们的 Schema 写得非常详尽（Hint 很多），这能极大减少用户疑惑。

---

## 4. 极限进化：下一步如何做到极致？ (Future Roadmap)

如果你想把“热点话题提醒”这个单一功能做到 **世界级 (State of the Art)**，后续路线图建议如下：

### 第一阶段：视觉冲击 (Visual Impact)
- **动态生成热搜图**：不再只是文字 `💡`。
- 调用 `html_render` 或 `Pillow`，生成一张仿 **微博热搜/B站热榜** 的图片。
    - 左边是排名（🔥 爆），右边是话题。
    - 配上群友的头像作为“相关用户”。
- **FOMO (错失恐惧)** 效果拉满：“你不在的这十分钟，群里发生了这么大的事？”

### 第二阶段：人格入侵 (Persona Injection)
- 目前的 AstrBot 是“旁观者”总结。
- **极致做法**：让 Bot **参与** 讨论。
- 触发热点后，Bot 不发总结，而是直接**引用**那句最热的话进行 吐槽/反问/站队。
- *例子*：“什么？詹姆斯不如库里？(引用某人发言) 数据不会说谎吧...”
- 这将从“工具”进化为“群宠”。

### 第三阶段：全知之眼 (The Eye)
- **跨群联动**：检测到 A 群在聊“服务器崩了”，B 群也在聊。
- 输出：“⚠️ **全域警报**：3个群正在同时讨论‘服务器炸了’，建议运维立即上线。”
- 这将使插件具备 **舆情监控** 级的价值。

---

**文档生成时间**: 2025-12-09
**适用版本**: v3.2
